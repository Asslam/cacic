<?php

namespace Cacic\CommonBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * SoftwareRelatorioRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class SoftwareRelatorioRepository extends EntityRepository
{
    /**
     * Gerar relatório de software customizado
     *
     * @param $filtros
     * @return array
     */
    public function gerarRelatorio($filtros) {

        $qb = $this->createQueryBuilder("rel")
            ->select(
                "so.teDescSo",
                "so.idSo",
                "so.inMswindows",
                "loc.idLocal",
                "loc.nmLocal",
                "r.teIpRede",
                "r.nmRede",
                "r.idRede",
                "rel.nomeRelatorio",
                "rel.idRelatorio",
                "COUNT(DISTINCT comp.idComputador) as numComp"
            )
            ->innerJoin("rel.softwares", "sw")
            ->innerJoin("CacicCommonBundle:PropriedadeSoftware", "prop", "WITH", "sw.idSoftware = prop.software")
            ->innerJoin("CacicCommonBundle:Computador", "comp", "WITH", "comp.idComputador = prop.computador")
            ->innerJoin("CacicCommonBundle:So", "so", "WITH", "so.idSo = comp.idSo")
            ->innerJoin("CacicCommonBundle:Rede", "r", "WITH", "comp.idRede = r.idRede")
            ->innerJoin("CacicCommonBundle:Local", "loc", "WITH", "loc.idLocal = r.idLocal")
            ->andWhere("comp.ativo IS NULL or comp.ativo = 't'")
            ->groupBy("so.teDescSo",
                "so.idSo",
                "so.inMswindows",
                "loc.idLocal",
                "loc.nmLocal",
                "r.teIpRede",
                "r.nmRede",
                "r.idRede",
                "rel.nomeRelatorio",
                "rel.idRelatorio"
            );

        if (!empty($filtros['softwares'])) {
            $softwares = $filtros['softwares'];
            $qb->andWhere("rel.idRelatorio IN ($softwares)");
        }

        if (!empty($filtros['nomeRelatorio'])) {
            $softwares = $filtros['nomeRelatorio'];
            $qb->andWhere("rel.nomeRelatorio IN ($softwares)");
        }

        if (!empty($filtros['locais'])) {
            $local_filter = $filtros['locais'];
            $qb->andWhere("loc.idLocal IN ($local_filter)");
        }

        if (!empty($filtros['redes'])) {
            $rede_filter = $filtros['redes'];
            $qb->andWhere("comp.idRede IN ($rede_filter)");
        }

        if (!empty($filtros['so'])) {
            $so_filter = $filtros['so'];
            $qb->andWhere("comp.idSo IN ($so_filter)");
        }

        return $qb->getQuery()->getArrayResult();
    }

    /**
     * Detalhar relatório de software customizado
     *
     * @param $filtros
     * @return array
     */
    public function gerarRelatorioDetalhar($filtros) {

        $qb = $this->createQueryBuilder("rel")
            ->select(
                "so.teDescSo",
                "so.idSo",
                "so.inMswindows",
                "loc.idLocal",
                "loc.nmLocal",
                "r.teIpRede",
                "r.nmRede",
                "r.idRede",
                "rel.nomeRelatorio",
                "rel.idRelatorio",
                "comp.idComputador",
                "comp.nmComputador",
                "comp.teIpComputador",
                "comp.teNodeAddress",
                'comp.dtHrUltAcesso'
            )
            ->innerJoin("rel.softwares", "sw")
            ->innerJoin("CacicCommonBundle:PropriedadeSoftware", "prop", "WITH", "sw.idSoftware = prop.software")
            ->innerJoin("CacicCommonBundle:Computador", "comp", "WITH", "comp.idComputador = prop.computador")
            ->innerJoin("CacicCommonBundle:So", "so", "WITH", "so.idSo = comp.idSo")
            ->innerJoin("CacicCommonBundle:Rede", "r", "WITH", "comp.idRede = r.idRede")
            ->innerJoin("CacicCommonBundle:Local", "loc", "WITH", "loc.idLocal = r.idLocal")
            ->andWhere("comp.ativo IS NULL or comp.ativo = 't'")
            ->groupBy("so.teDescSo",
                "so.idSo",
                "so.inMswindows",
                "loc.idLocal",
                "loc.nmLocal",
                "r.teIpRede",
                "r.nmRede",
                "r.idRede",
                "rel.nomeRelatorio",
                "rel.idRelatorio",
                "comp.idComputador",
                "comp.nmComputador",
                "comp.teIpComputador",
                "comp.teNodeAddress",
                'comp.dtHrUltAcesso'
            );

        if (!empty($filtros['softwares'])) {
            $softwares = $filtros['softwares'];
            $qb->andWhere("rel.idRelatorio IN ($softwares)");
        }

        if (!empty($filtros['nomeRelatorio'])) {
            $softwares = $filtros['nomeRelatorio'];
            if (is_array($softwares)) {
                $software_filter = implode("', '", $softwares);
            } else {
                $software_filter = $softwares;
            }
            $qb->andWhere("rel.nomeRelatorio IN ('$software_filter')");
        }

        if (!empty($filtros['locais'])) {
            $local_filter = $filtros['locais'];
            $qb->andWhere("loc.idLocal IN ($local_filter)");
        }

        if (!empty($filtros['redes'])) {
            $rede_filter = $filtros['redes'];
            $qb->andWhere("comp.idRede IN ($rede_filter)");
        }

        if (!empty($filtros['so'])) {
            $so_filter = $filtros['so'];
            $qb->andWhere("comp.idSo IN ($so_filter)");
        }

        return $qb->getQuery()->getArrayResult();
    }

    /**
     * CSV do relatório
     *
     * @param $filtros
     * @return array
     */
    public function gerarRelatorioCsv($filtros) {

        $qb = $this->createQueryBuilder("rel")
            ->select(
                "rel.nomeRelatorio",
                "loc.nmLocal",
                "r.teIpRede",
                "r.nmRede",
                "so.teDescSo",
                "COUNT(DISTINCT comp.idComputador) as numComp"
            )
            ->innerJoin("rel.softwares", "sw")
            ->innerJoin("CacicCommonBundle:PropriedadeSoftware", "prop", "WITH", "sw.idSoftware = prop.software")
            ->innerJoin("CacicCommonBundle:Computador", "comp", "WITH", "comp.idComputador = prop.computador")
            ->innerJoin("CacicCommonBundle:So", "so", "WITH", "so.idSo = comp.idSo")
            ->innerJoin("CacicCommonBundle:Rede", "r", "WITH", "comp.idRede = r.idRede")
            ->innerJoin("CacicCommonBundle:Local", "loc", "WITH", "loc.idLocal = r.idLocal")
            ->andWhere("comp.ativo IS NULL or comp.ativo = 't'")
            ->groupBy("so.teDescSo",
                "so.idSo",
                "so.inMswindows",
                "loc.idLocal",
                "loc.nmLocal",
                "r.teIpRede",
                "r.nmRede",
                "r.idRede",
                "rel.nomeRelatorio",
                "rel.idRelatorio"
            );

        if (!empty($filtros['softwares'])) {
            $softwares = $filtros['softwares'];
            $qb->andWhere("rel.idRelatorio IN ($softwares)");
        }

        if (!empty($filtros['nomeRelatorio'])) {
            $softwares = $filtros['nomeRelatorio'];
            $qb->andWhere("rel.nomeRelatorio IN ($softwares)");
        }

        if (!empty($filtros['locais'])) {
            $local_filter = $filtros['locais'];
            $qb->andWhere("loc.idLocal IN ($local_filter)");
        }

        if (!empty($filtros['redes'])) {
            $rede_filter = $filtros['redes'];
            $qb->andWhere("comp.idRede IN ($rede_filter)");
        }

        if (!empty($filtros['so'])) {
            $so_filter = $filtros['so'];
            $qb->andWhere("comp.idSo IN ($so_filter)");
        }

        return $qb->getQuery()->getArrayResult();
    }

    /**
     * CSV da lista de computadores
     *
     * @param $filtros
     * @return array
     */
    public function gerarRelatorioDetalharCsv($filtros) {

        $qb = $this->createQueryBuilder("rel")
            ->select(
                "comp.nmComputador",
                "comp.teNodeAddress",
                "comp.teIpComputador",
                "so.teDescSo",
                "loc.nmLocal",
                "r.teIpRede",
                "r.nmRede",
                'comp.dtHrUltAcesso'
            )
            ->innerJoin("rel.softwares", "sw")
            ->innerJoin("CacicCommonBundle:PropriedadeSoftware", "prop", "WITH", "sw.idSoftware = prop.software")
            ->innerJoin("CacicCommonBundle:Computador", "comp", "WITH", "comp.idComputador = prop.computador")
            ->innerJoin("CacicCommonBundle:So", "so", "WITH", "so.idSo = comp.idSo")
            ->innerJoin("CacicCommonBundle:Rede", "r", "WITH", "comp.idRede = r.idRede")
            ->innerJoin("CacicCommonBundle:Local", "loc", "WITH", "loc.idLocal = r.idLocal")
            ->andWhere("comp.ativo IS NULL or comp.ativo = 't'")
            ->groupBy("so.teDescSo",
                "so.idSo",
                "so.inMswindows",
                "loc.idLocal",
                "loc.nmLocal",
                "r.teIpRede",
                "r.nmRede",
                "r.idRede",
                "rel.nomeRelatorio",
                "rel.idRelatorio",
                "comp.idComputador",
                "comp.nmComputador",
                "comp.teIpComputador",
                "comp.teNodeAddress",
                'comp.dtHrUltAcesso'
            );

        if (!empty($filtros['softwares'])) {
            $softwares = $filtros['softwares'];
            $qb->andWhere("rel.idRelatorio IN (:softwares)")
                ->setParameter('softwares', $softwares);
        }

        if (!empty($filtros['nomeRelatorio'])) {
            $softwares = $filtros['nomeRelatorio'];
            if (is_array($softwares)) {
                $software_filter = implode("', '", $softwares);
            } else {
                $software_filter = $softwares;
            }
            $qb->andWhere("rel.nomeRelatorio IN ('$software_filter')");
        }

        if (!empty($filtros['locais'])) {
            $local_filter = $filtros['locais'];
            $qb->andWhere("loc.idLocal IN (:local_filter)")
                ->setParameter('local_filter', $local_filter);
        }

        if (!empty($filtros['redes'])) {
            $rede_filter = $filtros['redes'];
            $qb->andWhere("comp.idRede IN (:rede_filter)")
                ->setParameter('rede_filter', $rede_filter);
        }

        if (!empty($filtros['so'])) {
            $so_filter = $filtros['so'];
            $qb->andWhere("comp.idSo IN (:so_filter)")
                ->setParameter('so_filter', $so_filter);
        }

        return $qb->getQuery()->getArrayResult();
    }

    /**
     * Pega todos os relatórios públicos ou pertencentes ao usuário
     *
     * @param $idUsuario Usuário que está buscando os relatórios
     * @return array
     */
    public function findUser($idUsuario) {
        $qb = $this->createQueryBuilder('rel')
            ->orWhere("rel.nivelAcesso = 'publico'")
            ->orWhere("rel.idUsuario = :idUsuario")
            ->setParameter('idUsuario', $idUsuario);

        return $qb->getQuery()->getResult();
    }

    /**
     * Busca se o software está em algum relatório
     *
     * @param $software
     * @return array Relatório de software encontrado
     */
    public function findSoftware($software) {
        $qb = $this->createQueryBuilder('rel')
            ->innerJoin("rel.softwares", "sw")
            ->innerJoin("CacicCommonBundle:PropriedadeSoftware", "prop", "WITH", "sw.idSoftware = prop.software")
            ->innerJoin("CacicCommonBundle:ClassProperty", 'cl', 'WITH', 'cl.idClassProperty = prop.classProperty')
            ->orWhere('cl.nmPropertyName = :software')
            ->orWhere('sw.nmSoftware = :software')
            ->setParameter('software', $software);

        return $qb->getQuery()->getOneOrNullResult();
    }
}
