<?php

namespace Cacic\CommonBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * ErrosAgenteRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ErrosAgenteRepository extends EntityRepository
{
    public function pesquisar( $dataInicio = null, $dataFim = null, $locais = array(), $idComputador = null )
    {
        // Monta a Consulta bÃ¡sica...
        $query = $this->createQueryBuilder('log')
            ->select('log')
            ->innerJoin("CacicCommonBundle:Computador", "comp", "WITH", "comp.idComputador = log.computador")
            ->innerJoin("CacicCommonBundle:Rede", "r", "WITH", "comp.idRede = r.idRede");

        /**
         * Verifica os filtros que foram parametrizados
         */
        if ( $dataInicio ) {
            $query->andWhere( 'log.timestampErro >= :dtInicio' )->setParameter('dtInicio', ( $dataInicio.' 00:00:00' ));
        }

        if ( $dataFim ) {
            $query->andWhere( 'log.timestampErro <= :dtFim' )->setParameter('dtFim', ( $dataFim.' 23:59:59' ));
        }

        if ( count($locais) ) {
            $query->andWhere( 'r.idLocal IN (:locais)' )->setParameter('locais', $locais);
        }

        if (!empty($id_computador)) {
            $query->andWhere('comp.idComputador = :idComputador')->setParameter('idComputador', $idComputador);
        }

        return $query->getQuery()->execute();
    }
}

